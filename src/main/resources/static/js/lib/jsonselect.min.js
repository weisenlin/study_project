(function(a){function x(a){return{sel:q(a)[1],match:function(a){return w(this.sel,a)},forEach:function(a,b){return v(this.sel,a,b)}}}function w(a,b){var c=[];v(a,b,function(a){c.push(a)});return c}function v(a,b,c,d,e,f){var g=a[0]===","?a.slice(1):[a],h=[],i=!1,j=0,k=0,l,m;for(j=0;j<g.length;j++){m=u(b,g[j],d,e,f),m[0]&&(i=!0);for(k=0;k<m[1].length;k++)h.push(m[1][k])}if(h.length&&typeof b=="object"){h.length>=1&&h.unshift(",");if(s(b))for(j=0;j<b.length;j++)v(h,b[j],c,undefined,j,b.length);else for(l in b)b.hasOwnProperty(l)&&v(h,b[l],c,l)}i&&c&&c(b)}function u(a,b,c,d,e){var f=[],g=b[0]===">"?b[1]:b[0],h=!0,i;g.type&&(h=h&&g.type===t(a)),g.id&&(h=h&&g.id===c),h&&g.pf&&(g.pf===":nth-last-child"?d=e-d:d++,g.a===0?h=g.b===d:(i=(d-g.b)%g.a,h=!i&&d*g.a+g.b>=0));if(h&&g.has){var j=function(){throw 42};for(var k=0;k<g.has.length;k++){try{v(g.has[k],a,j)}catch(l){if(l===42)continue}h=!1;break}}h&&g.expr&&(h=p(g.expr,a)),b[0]!==">"&&b[0].pc!==":root"&&f.push(b),h&&(b[0]===">"?b.length>2&&(h=!1,f.push(b.slice(2))):b.length>1&&(h=!1,f.push(b.slice(1))));return[h,f]}function t(a){if(a===null)return"null";var b=typeof a;b==="object"&&s(a)&&(b="array");return b}function s(a){return Array.isArray?Array.isArray(a):b.call(a)==="[object Array]"}function r(a,b){var c=b,d={},g=i(a,b);g&&g[1]===" "&&(c=b=g[0],g=i(a,b)),g&&g[1]===f.typ?(d.type=g[2],g=i(a,b=g[0])):g&&g[1]==="*"&&(g=i(a,b=g[0]));for(;;){if(g===undefined)break;if(g[1]===".")g=i(a,b=g[0]),(!g||g[1]!==f.str)&&e("sra"),d.id&&e("nmi"),d.id=g[2];else if(g[1]===f.psc)(d.pc||d.pf)&&e("mpc"),g[2]===":first-child"?(d.pf=":nth-child",d.a=0,d.b=1):g[2]===":last-child"?(d.pf=":nth-last-child",d.a=0,d.b=1):d.pc=g[2];else{if(g[1]!==f.psf)break;if(g[2]===":val"||g[2]===":contains")d.expr=[undefined,g[2]===":val"?"=":"*=",undefined],g=i(a,b=g[0]),g&&g[1]===" "&&(g=i(a,b=g[0])),(!g||g[1]!=="(")&&e("pex"),g=i(a,b=g[0]),g&&g[1]===" "&&(g=i(a,b=g[0])),(!g||g[1]!==f.str)&&e("sex"),d.expr[2]=g[2],g=i(a,b=g[0]),g&&g[1]===" "&&(g=i(a,b=g[0])),(!g||g[1]!==")")&&e("epex");else if(g[2]===":has"){g=i(a,b=g[0]),g&&g[1]===" "&&(g=i(a,b=g[0])),(!g||g[1]!=="(")&&e("pex");var j=q(a,g[0],!0);g[0]=j[0],d.has||(d.has=[]),d.has.push(j[1])}else if(g[2]===":expr"){d.expr&&e("mexp");var k=o(a,g[0]);g[0]=k[0],d.expr=k[1]}else{(d.pc||d.pf)&&e("mpc"),d.pf=g[2];var l=h.exec(a.substr(g[0]));l||e("mepf"),l[5]?(d.a=2,d.b=l[5]==="odd"?1:0):l[6]?(d.a=0,d.b=parseInt(l[6],10)):(d.a=parseInt((l[1]?l[1]:"+")+(l[2]?l[2]:"1"),10),d.b=l[3]?parseInt(l[3]+l[4],10):0),g[0]+=l[0].length}}g=i(a,b=g[0])}c===b&&e("se");return[b,d]}function q(a,b,c){var d=[],f,g;b||(b=0);for(;;){var h=r(a,b);d.push(h[1]),h=i(a,b=h[0]),h&&h[1]===" "&&(h=i(a,b=h[0]));if(!h)break;if(h[1]===">")d.push(">"),b=h[0];else if(h[1]===",")f===undefined?f=[",",d]:f.push(d),d=[],b=h[0];else if(h[1]===")"){c||e("ucp"),g=1,b=h[0];break}}c&&!g&&e("mcp"),f&&f.push(d);return[b,f?f:d]}function p(a,b){if(a===undefined)return b;if(a===null||typeof a!="object")return a;var c=p(a[0],b),d=p(a[2],b);return l[a[1]][1](c,d)}function o(a,b){function c(a){return typeof a!="object"||a===null?a:a[0]==="("?c(a[1]):[c(a[0]),a[1],c(a[2])]}var d=n(a,b?b:0);return[d[0],c(d[1])]}function n(a,b){b||(b=0);var c=m(a,b),d;if(c&&c[1]==="("){d=n(a,c[0]);var f=m(a,d[0]);(!f||f[1]!==")")&&e("epex"),b=f[0],d=["(",d[1]]}else!c||c[1]&&c[1]!="x"?e("ee"):(d=c[1]==="x"?undefined:c[2],b=c[0]);var g=m(a,b);if(!g||g[1]==")")return[b,d];(g[1]=="x"||!g[1])&&e("bop");var h=n(a,g[0]);b=h[0],h=h[1];var i;if(typeof h!="object"||h[0]==="("||l[g[1]][0]<l[h[1]][0])i=[d,g[1],h];else{i=h;while(typeof h[0]=="object"&&h[0][0]!="("&&l[g[1]][0]>=l[h[0][1]][0])h=h[0];h[0]=[d,g[1],h[0]]}return[b,i]}function m(a,b){var d,e=j.exec(a.substr(b));if(e){b+=e[0].length,d=e[1]||e[2]||e[3]||e[5]||e[6];if(e[1]||e[2]||e[3])return[b,0,c(d)];if(e[4])return[b,0,undefined];return[b,d]}}function k(a,b){return typeof a===b}function i(a,b){b||(b=0);var d=g.exec(a.substr(b));if(!d)return undefined;b+=d[0].length;var h;d[1]?h=[b," "]:d[2]?h=[b,d[0]]:d[3]?h=[b,f.typ,d[0]]:d[4]?h=[b,f.psc,d[0]]:d[5]?h=[b,f.psf,d[0]]:d[6]?e("upc"):d[7]?h=[b,f.str,c(d[0])]:d[8]?e("ujs"):d[9]&&(h=[b,f.str,d[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]);return h}function e(a){throw new Error(d[a])}function c(a){try{if(JSON&&JSON.parse)return JSON.parse(a);return(new Function("return "+a))()}catch(b){e("ijs")}}var b=Object.prototype.toString,d={bop:"binary operator expected",ee:"expression expected",epex:"closing paren expected ')'",ijs:"invalid json string",mcp:"missing closing paren",mepf:"malformed expression in pseudo-function",mexp:"multiple expressions not allowed",mpc:"multiple pseudo classes (:xxx) not allowed",nmi:"multiple ids not allowed",pex:"opening paren expected '('",se:"selector expected",sex:"string expected",sra:"string required after '.'",uc:"unrecognized char",ucp:"unexpected closing paren",ujs:"unclosed json string",upc:"unrecognized pseudo class"},f={psc:1,psf:2,typ:3,str:4},g=/^(?:([\r\n\t\ ]+)|([*.,>\)\(])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child|has|expr|val|contains))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/,h=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,j=new RegExp('^\\s*(?:(true|false|null)|(-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)|("(?:[^\\]|\\[^"])*")|(x)|(&&|\\|\\||[\\$\\^<>!\\*]=|[=+\\-*/%<>])|([\\(\\)]))'),l={"*":[9,function(a,b){return a*b}],"/":[9,function(a,b){return a/b}],"%":[9,function(a,b){return a%b}],"+":[7,function(a,b){return a+b}],"-":[7,function(a,b){return a-b}],"<=":[5,function(a,b){return k(a,"number")&&k(b,"number")&&a<=b}],">=":[5,function(a,b){return k(a,"number")&&k(b,"number")&&a>=b}],"$=":[5,function(a,b){return k(a,"string")&&k(b,"string")&&a.lastIndexOf(b)===a.length-b.length}],"^=":[5,function(a,b){return k(a,"string")&&k(b,"string")&&a.indexOf(b)===0}],"*=":[5,function(a,b){return k(a,"string")&&k(b,"string")&&a.indexOf(b)!==-1}],">":[5,function(a,b){return k(a,"number")&&k(b,"number")&&a>b}],"<":[5,function(a,b){return k(a,"number")&&k(b,"number")&&a<b}],"=":[3,function(a,b){return a===b}],"!=":[3,function(a,b){return a!==b}],"&&":[2,function(a,b){return a&&b}],"||":[1,function(a,b){return a||b}]};a._lex=i,a._parse=q,a.match=function(a,b){return x(a).match(b)},a.forEach=function(a,b,c){return x(a).forEach(b,c)},a.compile=x})(typeof exports=="undefined"?window.JSONSelect={}:exports)